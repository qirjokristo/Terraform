
  resource "aws_launch_template" "kristo" {
  name = "kristo-asg"
  iam_instance_profile {
    name = aws_iam_role.kristo.name
  }
  image_id               = data.aws_ami.ubuntu2004
  instance_type          = "t3.micro"
  vpc_security_group_ids = aws_security_group.ec2_sg.id
}


resource "aws_autoscaling_group" "name" {
  name = "kristo_asg"
  min_size = 1
  max_size = length(data.available)
}


#!/bin/bash
apt-get update -y
apt-get install tasksel -y
dpkg --configure -a
apt-get update -y
tasksel install lamp-server
apt install php-mbstring -y
apt install unzip -y
apt install awscli -y
mysql --host=${db_host} --user=admin --password=adminadmin --execute "CREATE DATABASE project;
USE project;
CREATE TABLE login (username varchar(10),password varchar(10));
INSERT INTO login VALUES ('kristo','qirjo'),('marko','skendo'),('ardit','shehu');
"
aws s3 sync ${aws_bucket}/files/* /var/www/html/
unzip /var/www/html/aws.zip
rm /var/www/html/aws.zip
echo "<h3>Instance id:$(curl http://169.254.169.254/latest/meta-data/instance-id)</h3> >>index.html
systemctl restart apache2


resource "time_sleep" "wait" {
  depends_on      = [aws_instance.kristo]
  create_duration = "5m"

}
resource "aws_ami_from_instance" "kristo" {
  name               = "kristo-golden-ami"
  source_instance_id = aws_instance.kristo.id
  depends_on         = [time_sleep.wait]
  tags               = var.common_tags
}


resource "aws_launch_template" "kristo" {
  name = "kristo-lt"
  iam_instance_profile {
    name = aws_iam_role.kristo.name
  }
  image_id               = aws_ami_from_instance.kristo.id
  instance_type          = "t2.micro"
  vpc_security_group_ids = [aws_security_group.ec2_sg.id]
}
